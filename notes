08/15

Installing k8s

kubeadm init fails

$ sudo kubeadm init
[sudo] password for cloud_user:
[init] Using Kubernetes version: v1.24.3
[preflight] Running pre-flight checks
error execution phase preflight: [preflight] Some fatal errors occurred:
        [ERROR CRI]: container runtime is not running: output: E0815
        21:48:51.858012    4642 remote_runtime.go:925] "Status from runtime
        service failed" err="rpc error: code = Unimplemented desc = unknown
        service runtime.v1alpha2.RuntimeService"
        time="2022-08-15T21:48:51Z" level=fatal msg="getting status of runtime:
        rpc error: code = Unimplemented desc = unknown service
        runtime.v1alpha2.RuntimeService"
        , error: exit status 1
Workaround* (doesn't work)
* https://stackoverflow.com/questions/72504257/i-encountered-when-executing-kubeadm-init-error-issue
* https://github.com/containerd/containerd/issues/4581

NEXT:
Go through the installation docs:
https://kubernetes.io/docs/setup/
https://kubernetes.io/docs/setup/production-environment/container-runtimes/#install-and-configure-prerequisites
install test cluster on la
install minikube
install hub on kube with synopsysctl / helm

08/16
TEST TOOLS:

Kind installed and running fine
Installing Hub with Helm3
$ helm repo add synopsys https://sig-repo.synopsys.com/artifactory/sig-cloudnative

$ BD_NAME="bd"
$ kubectl create ns ${BD_NAME}
BD_SIZE="sizes-gen03/10sph"

cd /opt/blackduck/hub-2022.7.0/kubernetes/blackduck
helm install --help
Usage:
  helm install [NAME] [CHART] [flags]

$ helm install ${BD_NAME} synopsys/blackduck --namespace ${BD_NAME} -f ${BD_SIZE}.yaml --set tlsCertSecretName=${BD_NAME}-blackduck-webserver-certificate

Error: INSTALLATION FAILED: failed pre-install: unable to build kubernetes
object for pre-install hook blackduck/templates/postgres-config.yaml: error validating "": error validating data: unknown object type "nil" in ConfigMap.data.HUB_POSTGRES_HOST

08/17
test with helm2

https://github.com/helm/helm/issues/5100#issuecomment-533787541
deleted cluster, starting from scratch

# creat cluster with kind

same error: 
 helm install ${BD_NAME} synopsys/blackduck --namespace ${BD_NAME} -f
 ${BD_SIZE}.yaml --set
 tlsCertSecretName=${BD_NAME}-blackduck-webserver-certificate
 Error: INSTALLATION FAILED: failed pre-install: unable to build kubernetes
 object for pre-install hook blackduck/templates/postgres-config.yaml: error
 validating "": error validating data: unknown object type "nil" in
 ConfigMap.data.HUB_POSTGRES_HOST
 
08/19

* fix Github config
* fixed apt google repo config

08/20

* add ssh keys to the Ubuntu nodes
ssh-keygen
ssh-copy-id -i $K8S_KEY_NAME $K8S_NODE

* fix Ubuntu script(correct Google repo)
* run script on multiple nodes
 1/ Install pssh
 sudo yum install -y pssh
 2/ Create hosts file
 vi ~/.pssh_hosts
 Contents
 [user@]host[:port]
 3/ Test
 pssh -h ~/.pssh_hosts -i "hostname"

* set no sudo passwd
  with NOPASSWD:ALL still promts for password
  https://unix.stackexchange.com/questions/666207/setting-nopasswd-for-a-user-still-promts-for-a-password

NEXT: 
  
08/21 

* fix nopasswd sudo
  1/ check user sudo permissions
  sudo -l -U cloud_user
  2/ Edit cloud_user sudo config:
  sudo visudo -f /etc/sudoers.d/90-cloud-init-users

* run install script with pssh
  pssh -h ~/.pssh_hosts -o ~/pssh-logs "bash $SCRIPTNAME"
  
  [FAILURE] Timed out, Killed by signal 9
  pssh command will only last 60 seconds if you not input -t option.

  pssh -t 3600 -h ~/.pssh_hosts -o ~/pssh-logs "bash 2_configure_nodes_ubuntu.sh"

* initialize cluster
  1/ On a control plane node 

sudo kubeadm init --pod-network-cidr 192.168.0.0/16 --kubernetes-version 1.24.4

# Setup kubectl
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
kubectl get nodes

# install Calico Networking
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

# print cluster join command
kubeadm token create --print-join-command

  2/ Use the printed join command on the worker nodes to add them to the
  cluster

  3/ Check installation
kubectl get nodes

* namespaces(common commands)

* Install an app into a cluster
  Install Jenkins
  https://www.jenkins.io/doc/book/installing/kubernetes/

  1/ create jenkins ns
  kubectl create ns jenkins

  2/ Install helm
  wget https://get.helm.sh/helm-v3.9.3-linux-amd64.tar.gz
  tar xzvf helm-v3.9.3-linux-amd64.tar.gz
  mkdir ~/bin
  mv linux-amd64/helm ~/bin
  helm version

  3/ Configure Helm
  helm repo add jenkinsci https://charts.jenkins.io
  helm repo update
  helm search repo jenkinsci

  4/ Create a persistent volume
  wget https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-volume.yaml

  5/ Create a service account
  wget https://raw.githubusercontent.com/jenkins-infra/jenkins.io/master/content/doc/tutorials/kubernetes/installing-jenkins-on-kubernetes/jenkins-sa.yaml
  kubectl apply -f jenkins-sa.yaml

  6/ Install Jenkins
  6.1 
  wget https://raw.githubusercontent.com/jenkinsci/helm-charts/main/charts/jenkins/values.yaml
  mv values.yaml jenkins-values.yaml
  
  6.2 Modify jenkins-values.yaml
  nodePort: 32000
  storageClass: jenkins-pv
  serviceAccount:
    create: false
    name: jenkins
    annotations: {}
  
  6.3 Install chart
  chart=jenkinsci/jenkins
  helm install jenkins -n jenkins -f jenkins-values.yaml $chart

  6.4 Get your 'admin' user password by running:
  $ jsonpath="{.data.jenkins-admin-password}"
  $ secret=$(kubectl get secret -n jenkins jenkins -o jsonpath=$jsonpath)
  $ echo $(echo $secret | base64 --decode)

  6.5 Get the Jenkins URL to visit by running these commands in the same shell:
  $ jsonpath="{.spec.ports[0].nodePort}"
  $ NODE_PORT=$(kubectl get -n jenkins -o jsonpath=$jsonpath services jenkins)
  $ jsonpath="{.items[0].status.addresses[0].address}"
  $ NODE_IP=$(kubectl get nodes -n jenkins -o jsonpath=$jsonpath)
  $ echo http://$NODE_IP:$NODE_PORT/login

  6.6 Installation failed
  kubectl get pods -n jenkins
  NAME        READY   STATUS                  RESTARTS       AGE
  jenkins-0   0/2     Init:CrashLoopBackOff   6 (4m7s ago)   10m
  
  

NEXT:
* write Ubuntu install readme

08/22

* Troubleshoot Jenkins Installation
kubectl describe pod -n jenkins jenkins-0

Events:
Back-off restarting failed container

    * containers
    jenkins
    config-reload

    kubectl logs -n jenkins jenkins-0 -c jenkins
    Error from server (BadRequest):
    container "jenkins" in pod "jenkins-0" is waiting to start:
    PodInitializing

kubectl get pod jenkins-0 -n jenkins --template

'{{.status.initContainerStatuses}}'
[map[containerID:containerd://679590f019d1dc5189fa64169a4ab4434ec32019e3abcf44b6ff6b93758bbe56
image:docker.io/jenkins/jenkins:2.346.3-jdk11
imageID:docker.io/jenkins/jenkins@sha256:cc62444630fb4b7c4694ac6b11b68dc64864a67fd98121194f913027733c9dce
lastState:map[terminated:map[containerID:containerd://679590f019d1dc5189fa64169a4ab4434ec32019e3abcf44b6ff6b93758bbe56
exitCode:2 finishedAt:2022-08-22T14:37:11Z reason:Error
startedAt:2022-08-22T14:37:11Z]] name:init ready:false restartCount:37
state:map[waiting:map[message:back-off 5m0s restarting failed container=init
pod=jenkins-0_jenkins(e35c1f0a-726c-4475-9641-4e000ac6b4b8)
reason:CrashLoopBackOff]]]]
